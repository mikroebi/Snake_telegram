<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Snake Game Kids</title>
  <!-- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --canvas: #020617;
      --snake: #22c55e;
      --apple: #ef4444;
      --text: #e5e7eb;
      --btn-bg: #1e293b;
    }
    body.light {
      --bg: #f8fafc;
      --canvas: #cbd5e1;
      --snake: #16a34a;
      --apple: #dc2626;
      --text: #020617;
      --btn-bg: #e2e8f0;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-family: system-ui, sans-serif;
      touch-action: manipulation;
    }
    .game { text-align: center; }
    canvas {
      background: var(--canvas);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,.4);
      display: block;
      margin: 0 auto;
    }
    .top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      width: 320px;
      margin: 0 auto 10px auto;
    }
    .btn-opt {
      background: none;
      border: 1px solid var(--text);
      color: var(--text);
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    .score-board {
      margin-top: 10px;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
      width: 320px;
      margin: 10px auto;
    }
    
    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ù‡Øªâ€ŒØ¯Ø§Ø± */
    .controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      width: 200px;
      margin: 20px auto 0 auto;
    }
    .d-btn {
      background: var(--btn-bg);
      border: none;
      color: var(--text);
      font-size: 24px;
      height: 60px;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 0 rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }
    .d-btn:active {
      transform: translateY(4px);
      box-shadow: none;
    }
  </style>
</head>
<body>
  <div class="game">
    <div class="top">
      <button class="btn-opt" id="theme">ğŸŒ— ØªÙ…</button>
      <button class="btn-opt" id="sound">ğŸ”Š ØµØ¯Ø§</button>
    </div>
    
    <canvas id="game" width="320" height="320"></canvas>
    
    <div class="score-board">
      <div>Ø§Ù…ØªÛŒØ§Ø²: <span id="score">0</span></div>
      <div>Ø±Ú©ÙˆØ±Ø¯: <span id="highScore">0</span></div>
    </div>

    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ú©ÙˆØ¯Ú© -->
    <div class="controls">
      <div></div>
      <button class="d-btn" id="up">â¬†ï¸</button>
      <div></div>
      <button class="d-btn" id="left">â¬…ï¸</button>
      <button class="d-btn" id="down">â¬‡ï¸</button>
      <button class="d-btn" id="right">â¡ï¸</button>
    </div>
  </div>

<script>
// --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… ---
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand(); // ØªÙ…Ø§Ù… ØµÙØ­Ù‡ Ú©Ø±Ø¯Ù† Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù…

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const eatSound = new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg');

const grid = 16;
let count = 0;
let score = 0;
let highScore = 0;
let soundOn = true;

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø±Ú©ÙˆØ±Ø¯ Ø§Ø² ÙØ¶Ø§ÛŒ Ø§Ø¨Ø±ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…
tg.CloudStorage.getItem('snake_highscore', (err, value) => {
  if (!err && value) {
    highScore = parseInt(value);
    document.getElementById('highScore').innerText = highScore;
  }
});

let snake = { x:160, y:160, dx:grid, dy:0, cells:[], maxCells:4 };
let apple = { x:160, y:160 };

function rand(min,max){return Math.floor(Math.random()*(max-min))+min;}

function loop(){
  requestAnimationFrame(loop);
  
  // --- Ú©Ø§Ù‡Ø´ Ø³Ø±Ø¹Øª Ø¨Ø§Ø²ÛŒ ---
  // Ø¹Ø¯Ø¯ 4 Ù‚Ø¨Ù„ÛŒ Ø¨Ù‡ 10 ØªØºÛŒÛŒØ± Ú©Ø±Ø¯. Ù‡Ø±Ú†Ù‡ Ø¹Ø¯Ø¯ Ø¨Ø²Ø±Ú¯ØªØ±ØŒ Ø³Ø±Ø¹Øª Ú©Ù…ØªØ±.
  if(++count < 10) return; 
  count=0;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  snake.x+=snake.dx; snake.y+=snake.dy;
  
  // Ø¹Ø¨ÙˆØ± Ø§Ø² Ø¯ÛŒÙˆØ§Ø±Ù‡Ø§
  if(snake.x<0) snake.x=canvas.width-grid;
  if(snake.x>=canvas.width) snake.x=0;
  if(snake.y<0) snake.y=canvas.height-grid;
  if(snake.y>=canvas.height) snake.y=0;

  snake.cells.unshift({x:snake.x,y:snake.y});
  if(snake.cells.length>snake.maxCells) snake.cells.pop();

  // Ø±Ø³Ù… Ø³ÛŒØ¨
  ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--apple');
  ctx.fillRect(apple.x,apple.y,grid-1,grid-1);

  // Ø±Ø³Ù… Ù…Ø§Ø±
  ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--snake');
  snake.cells.forEach((c,i)=>{
    ctx.fillRect(c.x,c.y,grid-1,grid-1);
    
    // Ø®ÙˆØ±Ø¯Ù† Ø³ÛŒØ¨
    if(c.x===apple.x && c.y===apple.y){
      snake.maxCells++; 
      score++; 
      document.getElementById('score').innerText=score;
      if(soundOn) eatSound.play();
      apple.x=rand(0,20)*grid; apple.y=rand(0,20)*grid;
    }
    
    // Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø§ Ø®ÙˆØ¯ (Ø¨Ø§Ø®ØªÙ†)
    for(let j=i+1;j<snake.cells.length;j++){
      if(c.x===snake.cells[j].x && c.y===snake.cells[j].y){ reset(); }
    }
  });
}

function reset(){
  // Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø±Ú©ÙˆØ±Ø¯
  if (score > highScore) {
    highScore = score;
    document.getElementById('highScore').innerText = highScore;
    // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù…
    tg.CloudStorage.setItem('snake_highscore', highScore.toString(), (err, stored) => {
        if(err) console.log(err);
    });
  }

  snake={x:160,y:160,dx:grid,dy:0,cells:[],maxCells:4};
  score=0; 
  document.getElementById('score').innerText=0;
}

// --- Ú©Ù†ØªØ±Ù„Ø±Ù‡Ø§ ---
function changeDir(dir) {
    if(dir==='left' && snake.dx===0){snake.dx=-grid;snake.dy=0}
    else if(dir==='up' && snake.dy===0){snake.dy=-grid;snake.dx=0}
    else if(dir==='right' && snake.dx===0){snake.dx=grid;snake.dy=0}
    else if(dir==='down' && snake.dy===0){snake.dy=grid;snake.dx=0}
}

// Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø±ÙˆÛŒ ØµÙØ­Ù‡
document.getElementById('left').onclick = () => changeDir('left');
document.getElementById('up').onclick = () => changeDir('up');
document.getElementById('right').onclick = () => changeDir('right');
document.getElementById('down').onclick = () => changeDir('down');

// Ú©ÛŒØ¨ÙˆØ±Ø¯
addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft') changeDir('left');
  if(e.key==='ArrowUp') changeDir('up');
  if(e.key==='ArrowRight') changeDir('right');
  if(e.key==='ArrowDown') changeDir('down');
});

// UI Buttons
document.getElementById('theme').onclick=()=>document.body.classList.toggle('light');
const soundBtn = document.getElementById('sound');
soundBtn.onclick=()=>{
    soundOn=!soundOn; 
    soundBtn.innerText=soundOn?'ğŸ”Š ØµØ¯Ø§':'ğŸ”‡ ØµØ¯Ø§'
};

requestAnimationFrame(loop);
</script>
</body>
</html>
